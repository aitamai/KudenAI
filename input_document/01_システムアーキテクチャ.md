# 01_システムアーキテクチャ（現行システム）

| 層 | 技術 / 役割 |
| --- | --- |
| フロントエンド | **React / Next.js（UI層）**<br/>チャット・日記・マイページ・SNS画面を提供し、PWA化と多言語UIを担保する |
| アプリケーション層 | **Django（認証・メインロジック・APIゲートウェイ）**<br/>Kuden.AI ドメイン：AIアバター管理、トークン台帳、課金連携、公開/モデレーション制御 |
| 非同期処理層 | **Celery（非同期タスク・定期バッチ）**<br/>usage集計、RAG埋め込み、トークンロールアップ、通知配送 |
| キャッシュ層 | **Redis（セッション・OTP・一時データ・キュー）**<br/>SSO/2FAセッション、レート制限、WebRTCシグナリングの短期保存にも利用 |
| AI/RAG層 | **LangChain（RAGパイプライン制御）**<br/>OpenAI / Gemini / Claude など複数LLMを抽象化し、プロンプトテンプレートとソース選択を統制 |
| ベクトルDB層 | **Pinecone（アバター・日記・ナレッジベクトル管理）**<br/>個人/業務の埋め込みをスコープ別に保持し、会話/日記で引用ハイライト |
| 追跡 / 可視化層 | **Langfuse（LLMトレース・使用トークン監視・コスト管理）**<br/>トレースIDと token_ledger を連携し、異常検知やコスト配賦を可視化 |
| 永続DB層 | **PostgreSQL（ユーザー・アバター・会話履歴・課金ログ）**<br/>JSONB と部分暗号で PII/プロンプト/台帳を保持、ACIDでトークン精算を保証 |
| 認証 / 決済連携 | **Stripe + Django プラン管理**<br/>サブスク/アドオン課金、Webhookの冪等処理、プラン/残量をDjango側で制御 |

## 補足
- Next.js と Django は GraphQL/REST API で連携し、SSR/ISR による高速表示を実現
- Celery ワーカーは Redis/Kafka をキューとして利用し、トークン集計とBigQuery転送を非同期化
- LangChain からの LLM 呼び出しは Langfuse で全トレース管理し、token_ledger と突合する
- Stripe Webhook は Django 側の冪等性キーで再送を吸収し、usage_counters に反映
