# 06_バックエンド概要（CakePHP + Python）

> モノリシックな CakePHP + Python から Django + Celery へ移行する計画だが、既存資産を活かすためのハイブリッド構成を整理する。

## 全体構成
- **Django (FastAPI 補助)**: 認証、AIアバター管理、トークン台帳、RAG API、Stripe Webhook を集約。Django-OTP と RBAC を採用
- **Legacy CakePHP**: 一部管理画面/LP/CMS を継続運用。Django から API 経由で必要項目のみ同期
- **Python サービス**: Celery ワーカー（埋め込み/Usage バッチ/Redis フラッシュ）、LangChain 実行、Whisper STT プロキシ
- **Redis**: セッション/OTP/日記バッファ/ジョブキュー
- **PostgreSQL**: コアデータ（ユーザー/日記/会話/台帳）。MySQL→PostgreSQL 移行のため、Cake 側は読み取り専用
- **Pinecone & Langfuse**: Embedding 保存と LLM/RAG の可視化

## 主なサービス
1. **Auth Service (Django)**: 2FA、パスワードリセット、セッション管理、RBAC 判定
2. **Diary/Chat Service**: 会話管理、Whisper 連携、Redis バッファ、日次フラッシュ。RAG ソース選択、引用生成
3. **Avatar Service**: プロンプト生成、trait 推定、公開 URL 発行、固定チャットルーム作成
4. **Billing Service**: token_ledger 記帳、usage_counters ロールアップ、Stripe サブスク & アドオン処理
5. **Embedding Service**: LangChain + Pinecone Upsert、hash ID 生成、Langfuse trace
6. **Admin/Moderation**: 通報キュー、監査ログ、プラン/残量調整

## API/プロトコル
- REST + GraphQL を提供。Next.js からは BFF（/api/*）を介して呼び出し
- WebSocket/WebRTC シグナリングは Django Channels（もしくは FastAPI WebSocket）で処理
- Stripe Webhook は Django で受信 → Celery が冪等処理して課金/usage を更新

## 非同期処理
- Celery Beat が 03:00 に Redis → Postgres フラッシュ、BigQuery 転送
- バックグラウンドで trait 判定/AI テスト/埋め込み生成を実施
- 失敗時は再試行＆Slack 通知。ジョブ履歴は `admin_events` に記録

## セキュリティ/インフラ
- AWS: VPC/サブネット分離、ALB/CloudFront+ACM、ECS or AppRunner、RDS(PostgreSQL)、ElastiCache(Redis)、S3（署名URL）
- WAF/SG で最小権限、PII 列暗号化、RBAC、2FA 必須
- CI/CD: GitHub Actions → pytest/ESLint/Bandit/ZAP、OIDC で AWS デプロイ

