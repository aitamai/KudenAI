# 04_主要機能シーケンス（現行システム）

## 1. ログイン + 2FA + OTP
1. ユーザーがメール/パスワードを送信
2. Django が `authenticate` → 成功なら Django-OTP がコード生成、Redis に保存、メール送信
3. UI が OTP 入力画面へ遷移
4. ユーザーが 6 桁コードを入力 → Django が Redis と比較、5 分以内なら成功
5. 成功時にセッショントークン発行、`session:{user_id}:{uuid}` を Redis へ書き込み
6. 連続失敗 5 回でアカウントロック → 管理 UI から解除

## 2. パスワードリセット
1. ログイン画面下部リンク → メール入力
2. Django がリセットトークンを生成し Redis に 10 分 TTL 保存、メール送信
3. ユーザーがリンクにアクセス → 新パスワードを設定
4. 成功時に全セッション削除・監査ログ記録・通知メール送信

## 3. 日記（AI会話 UI）
1. ダッシュボードで「日記」開始 → AI がその日の質問を生成（ランダム/文脈依存）
2. ユーザー回答（テキスト or 音声）。音声は Whisper で STT、結果を UI に表示
3. 会話ペアを Redis `diary:buffer` に保存し、即時補助が必要なら LangChain で要約/追記提案
4. 会話終了時または日次で Celery が PostgreSQL `diary_entries` + `messages` へ書き込み
5. 保存トリガーで Embedding 生成 → Pinecone upsert（ID=hash(user_id+text)）
6. Langfuse trace へ質問・回答・要約・トークン消費を記録

## 4. AI アバター作成～公開
1. プロフィール画面で性格診断/文体サンプル/機密項目を入力（入力率%をリアルタイム表示）
2. ユーザーが「文体チェック」「アバターチェック」を実行 → LangChain が trait を推定し `avatar_traits` に保存
3. プロンプト生成・安全ルール設定 → テスト会話で検証、Langfuse に trace
4. 公開設定 ON で URL（`https://app.kuden.ai/@handle`）を発行し、ダッシュボード/タイムラインに表示
5. いつでもチャットボットを起動可能。ユーザー/訪問者は同 URL から会話開始

## 5. トークン記帳・利用量表示
1. 各メッセージ完了時に `actual_tokens` を算出
2. Django が残量 → OK なら `token_ledger` にユーザー→運営、運営→アバターの2仕訳を連記
3. `usage_counters` を日次更新、Langfuse で可視化
4. ダッシュボードで利用量/課金履歴を照会（PostgreSQL + BigQuery）

## 6. Embedding & RAG
1. 会話/日記/診断が保存されたタイミングで Celery ジョブ生成
2. Embedding 生成 → Pinecone upsert → Langfuse trace
3. RAG 呼び出し時に既存日記を検索し、引用を UI に表示。非公開フラグ付きは検索対象外

## 7. 会話バッファ保存
1. 1 日分の会話セクションを Redis に保持
2. 毎日 03:00、Celery が Postgres へ永続化し、Pinecone/Langfuse 連携を実行
3. 成功後に Redis バッファ削除

