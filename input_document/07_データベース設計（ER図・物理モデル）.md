# 07_データベース設計（ER図・物理モデル）

## コアエンティティ
| テーブル | 主キー | 概要 |
| --- | --- | --- |
| `users` | `id` | メール/ハッシュ化パス、locale、status、2FA 設定。`email_enc` など AES 列暗号化 |
| `profiles` | `user_id` | 名前・職業・年齢・居住地・AI公開フラグ・機密チェックボックス結果（mask_flag） |
| `plans` | `id` | Free/Pro/Business。アバター上限・月次トークン上限・価格 |
| `subscriptions` | `id` | Stripe 連携、current_period_end、status |
| `avatars` | `id` | owner_user_id、公開設定、version、fixed_url、trait_score_json |
| `avatar_prompts` | `id` | system_prompt、safety_rules、params_json、version、is_active |
| `avatar_traits` | `id` | avatar_id、trait_name、score、evidence_text |
| `diary_entries` | `id` | user_id、date、summary、suggestions_json、audio_url、sentiment、tags_json |
| `diary_messages` | `id` | diary_id、role(user|ai)、content、tokens_in/out、source_refs_json |
| `conversations` | `id` | user_id、avatar_id、started_at、ended_at、lang、meta_json |
| `messages` | `id` | conversation_id、role、text、tokens_input/output、source_refs_json |
| `rag_sources` | `id` | user_id|org_id、type、config_json、visibility、last_sync_at |
| `embeddings` | `id` | owner_scope(user|org|avatar)、object_id、vector、hash、meta_json |
| `token_ledger` | `id` | from/to、token_amount、unit_price、purpose、conv_id、msg_id、hash/prev_hash、status |
| `usage_counters` | `id` | owner_type、owner_id、period_day、tokens_in/out、conv_count |
| `purchases` | `id` | user_id、type(plan|addon_tokens)、amount_jpy、tokens_granted、stripe_payment_intent |
| `admin_events` | `id` | actor_user_id、action、target_type、payload_json、ts |
| `audit_logs` | `id` | user_id、action、ip、ua、ts |

## Redis / 一時テーブル
- `otp:{user_id}`: 5分 TTL の 2FA コード
- `pwdreset:{token}`: 10分 TTL のパスワードリセットトークン
- `session:{user_id}:{uuid}`: セッションキー（マルチセッション）
- `diary:buffer:{user_id}:{date}`: 1日分の会話を保存。03:00 バッチで `diary_entries` へ移行

## ベクトルデータ
- Pinecone の `namespace = user|org|avatar`
- upsert ID = `hash(user_id + text)` で重複を排除
- RAG 対象外フラグ付きメッセージは `embeddings.skip_reason` に記録

## 暗号化/セキュリティ
- PII 列（メール・住所・音声 URL 等）は AES-GCM で暗号化、Django ORM から透過復号
- RBAC で列レベルのマスキング、監査ログにアクセス記録
- token_ledger は不可逆。訂正は `status=reversed` + 相殺行

## 移行
- 現行 MySQL → PostgreSQL へ移行。ステップ: データ抽出 → 型変換 → マイグレーション → 整合性検証（hash/prev_hash、件数）
- CakePHP は移行期間のみ MySQL 読み取り、書き込みは Django/Postgres に集約

