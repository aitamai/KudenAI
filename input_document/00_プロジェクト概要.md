# 00_プロジェクト概要（現行システム）

## 1. 機能ドメイン（網羅）

### A. SNS基盤（発見→登録→利用）
- **発見/探索**: アバター一覧・検索（タグ/言語/人気/新着/用途）、詳細ページ
- **ソーシャル**: フォロー/フォロー解除、いいね、コメント、シェア（外部/アプリ内リシェア）、タイムライン（自分/フォロー/全体）
- **コレクション**: 「お気に入り/マイアバター」への登録・並べ替え
- **公開スコープ**: 公開/限定公開/非公開、年齢制限・企業用途フラグ
- **通報/ブロック**: モデレーション、違反報告、アカウント/アバターのブロック
- **多言語**: UI i18n + アバターの言語対応（多言語プロンプト/説明）

### B. アカウント/課金・プラン
- **登録/ログイン**: メール+パス、SSO（Google/Apple）、2FA
- **プラン管理**: Free/Pro/Business（アバター上限、月間会話回数/トークン上限差異）
- **決済**: 定額サブスク（Stripe）+ 従量/追加トークン購入（アドオン）
- **上限制御**: アバター作成数/会話回数/日次レート制限、超過時の追加購入導線
- **請求/領収**: 請求履歴、インボイス/JPN要件対応

### C. AIアバター作成/編集/アップデート
- **ソース入力**: 性格診断・文体サンプル・設定情報（目的/禁則/口調/言語/知識境界）
- **プロンプト基盤**: システム/ロール/安全/評価/テスト用の分離管理、バージョンと差分追跡
- **ベクトル知識**: 個人RAG（私的日記/ノート/添付）＋業務RAG（外部ナレッジ）
- **検証**: 代表対話セットでの回帰テスト、毒性/リーク/不正出力ガード
- **公開**: 固定URL/埋め込みウィジェット/QR

### D. 会話UI/日記UI
- **会話**: テキスト+WebRTC音声（双方向/ストリーミング）、Whisper/STT
- **日記**: 「AIが質問→回答→要約/追記提案」、タグ/感情/健康/ToDo抽出
- **履歴**: セッション/メッセージ単位で完全保存（編集不可ログ＋ユーザー閲覧用写し）
- **RAG**: 個人/業務ソース選択、引用ハイライト、出典表示
- **多言語**: UIと言語自動検知/切替、LLMプロンプトも多言語対応

### E. 管理（ユーザー/システム/運用）
- **ユーザー管理**: 有効/無効、強制パスリセット、トークン獲得/消費台帳閲覧
- **監査ログ**: 重要操作（課金/権限/公開設定/プロンプト改変）
- **お知らせ/広告配信**: プラン/地域/使用状況でのセグメント配信
- **ページ編集**: CMS（ヘルプ/ポリシー/LP）
- **通報審査**: モデレーションキュー、アクション履歴
- **メトリクス**: MAU/DAU、会話成功率、RAG命中率、ARPU、LTV、トークン収支

## 2. 主要ユーザーフロー（実装指針）
- **アバター探索→お気に入り→使用開始**: 検索→詳細→お気に入り登録→会話開始→会話ごとのトークン移転→履歴/請求反映
- **アバター作成→検証→公開**: 診断/文体投入→プロンプト自動生成→テスト→公開→タイムライン掲出
- **課金/上限制御**: プラン設定→会話前の残量チェック→不足なら追加トークン購入→台帳記帳
- **日記（音声）**: WebRTC収音→STT→要約/追記→DB保存→必要に応じRAG知識へ反映
- **業務RAG**: ソース接続（Drive/Notion/S3等）→埋め込み→権限/範囲指定→会話時に引用表示

## 3. 最小ERD（主キーのみ・省略形）
- `users(id, email, plan_id, locale, status, created_at, …)`
- `plans(id, name, avatar_limit, monthly_token_quota, price, …)`
- `avatars(id, owner_user_id, name, lang, visibility, version, …)`
- `avatar_prompts(id, avatar_id, system_prompt, safety_rules, params_json, version, is_active)`
- `avatar_assets(id, avatar_id, type, url, meta_json)`
- `follows(id, follower_user_id, followee_user_id|avatar_id, created_at)`
- `favorites(id, user_id, avatar_id, sort_order)`
- `conversations(id, user_id, avatar_id, started_at, ended_at, lang, meta_json)`
- `messages(id, conversation_id, role(user|avatar|system), text, tokens_input, tokens_output, created_at, source_refs_json)`
- `diaries(id, user_id, date, text, audio_url, sentiment, tags_json)`
- `rag_sources(id, user_id|org_id, type, config_json, visibility)`
- `embeddings(id, owner_scope(user|org|avatar), object_id, vector, meta_json)`
- `subscriptions(id, user_id, plan_id, stripe_sub_id, status, current_period_end)`
- `purchases(id, user_id, type(plan|addon_tokens), amount_jpy, tokens_granted, stripe_payment_intent, created_at)`
- `token_ledger(id, ts, from_type, from_id, to_type, to_id, token_amount, unit_price, purpose, conv_id, msg_id, hash, prev_hash, signature, status)`
- `usage_counters(id, owner_type(user|avatar), owner_id, period_day, tokens_in, tokens_out, conv_count)`
- `admin_events(id, actor_user_id, action, target_type, target_id, payload_json, ts)`
- `audit_logs(id, user_id, action, ip, ua, ts)`

ポイント:
- `token_ledger` は不可逆（更新不可・論理取消は `status=reversed` + 相殺エントリ）
- `hash/prev_hash` でチェーン化し改ざん検知
- 集計は `usage_counters` に日次ロールアップ（課金・制限判定を高速化）

## 4. トークン移動ロジック（使用者/被使用アバター/運営）
- **原則**: 1メッセージ完了時に実績トークンを確定し、1トランザクション/2仕訳（二重仕訳）
  - a) 使用者（User）→運営（Operator）: 消費
  - b) 運営（Operator）→被使用（Avatar/オーナーUser）: 分配（手数料控除後）
- **整合性**: 不整合時は原状回復仕訳（reversal + 再計上）、冪等性キー= `conv_id,msg_id`
- **シーケンス**:
  1. 会話APIのLLM完了で `actual_tokens` を確定
  2. 制限判定（残量/プラン/不正検知）を通過
  3. DBトランザクションで token_ledger へ仕訳記録 + usage_counters 当日分インクリメント
  4. 非同期で BigQuery/Redshift へストリームし監査/BIに利用
  5. Langfuse に trace/span（actual_tokens・金額・台帳ID）を記録
  6. エラー時はDBロールバック後に再試行
- **料金/配分例**: 原価(LLM) + 30%プラットフォーム手数料 + 70%クリエイター分配。端数は運営で繰上げ/繰下げ

## 5. 技術スタック/実装ポイント
- **FE**: Next.js(PWA) + WebRTC(音声) + Zustand/Redux、`next-intl` による i18n
- **BE**: FastAPI or Django（認証/管理はDjango優位）+ Celery（集計/転送）
- **DB**: PostgreSQL（JSONB活用・部分暗号）+ Redis（セッション/OTP/レート）
- **Vector/RAG**: Pinecone + LangChain、引用スニペット保存
- **Observability**: Langfuse（LLM/埋込/RAG）+ Sentry + CloudWatch
- **Payments**: Stripe（Sub＋Addon）+ Webhook（冪等キー/署名検証）
- **Warehouse**: BigQuery もしくは Redshift Serverless（Airbyte or Pub/Sub）
- **Security**: 2FA、RBAC、PII列暗号、WAF、監査ログ、レート制限、Abuse対策
- **CI/CD**: GitHub Actions（pytest, ESLint, Bandit, ZAP baseline）+ OIDC to AWS

## 6. 優先度（MVP→本開発）
- **MVP（0→1）**: プラン/課金/上限制御、アバター探索/お気に入り/会話開始、アバター作成（診断+文体→プロンプト生成）、会話/日記（テキスト+音声入力、要約）、最小 token_ledger + usage_counters（日次）、多言語UI基礎（日本語/英語）
- **本開発（1→10）**: タイムライン/いいね/コメント/シェア/通報、業務RAG（外部連携・権限制御）、クリエイター収益ダッシュボード・税/支払、高度モデレーション/ポリシー/広告配信、アバター検証自動テスト/回帰
