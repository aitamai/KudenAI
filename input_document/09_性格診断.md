# 性格診断について

本書は、既存アセットを Django / Celery / Redis / LangChain / Pinecone / Langfuse / PostgreSQL へ統合する際に参照させるためのドキュメントです。内容は 2025-08-31 時点で確認できたリポジトリ構成に基づいています。また、性格診断は現在のログイン/マイページ/アバター作成フローへシームレスに組み込み、ユーザーは既存アカウントで診断を受けます。診断に使用する質問票・設問セットは事業側で用意し、本ドキュメントではシステム統合・保存・可視化の実装枠組みを定義します。

---

## 1. リポジトリ調査結果

| 項目 | 所見 |
| --- | --- |
| ソースツリー | `backend/mysql`、`frontend/node_modules`、`mysql/…` など空ディレクトリのみ。アプリケーションコードや設定ファイルは未配置。 |
| データ資産 | `questions.csv`、`dump.sql` などの名前付きディレクトリは存在するが中身は空で、テーブル定義・スキーマを推測できず。 |
| 運用スクリプト | Dockerfile / docker-compose / CI 設定等は未提供。 |
| 結論 | 現状は要件のみが共有されており、実装資産を流用できないため「新規リプラットフォーム」として扱う必要がある。 |

> **アクション:** もし別場所にソースやデータが存在する場合は追加で共有し、本ドキュメントを随時更新する。

---

## 2. 目標アーキテクチャ概要

| レイヤ | 採用技術 | 役割 |
| --- | --- | --- |
| プレゼンテーション (Web/PWA) | Next.js 系フレームワーク + Service Worker | マイページ・SNS 画面を多言語/オフライン対応で提供。 |
| アプリケーション / API | **Django** (REST/GraphQL, JWT/SSO 認証) | 認証・管理画面・ビリング・AI アバタードメイン API を集約。 |
| ドメインアプリ | `kuden_ai` Django アプリ | AI アバター管理、トークン台帳、課金連携、公開/モデレーション統制。 |
| 非同期処理 | **Celery** + Redis broker/beat | usage 集計、RAG 埋め込み、トークンロールアップ、通知配送など。 |
| キャッシュ/キュー | **Redis** | セッション、OTP、レート制限、WebRTC シグナリング、Celery backend。 |
| AI/RAG 制御 | **LangChain** | OpenAI / Gemini / Claude 等 LLM の抽象化、プロンプト管理、ソース選択。 |
| ベクトル DB | **Pinecone** | アバター・日記・ナレッジの埋め込みをテナント/スコープ別に保持。 |
| 追跡・可視化 | **Langfuse** | LLM トレース、トークン使用量監視、コスト配賦、異常検知。 |
| 永続 DB | **PostgreSQL** | ユーザー、アバター、会話履歴、課金ログを JSONB + 部分暗号で管理。 |

---

## 3. ドメイン機能マッピング

> **前提:** 性格診断 UI/API は既存システムへ統合し、ログイン・通知・課金・トークン管理など既存コンポーネントを流用する。診断質問の内容は事業側で随時提供され、本システムでは設問の配信・回答保存・アバター反映を担う。

| 機能 | 説明 | 担当コンポーネント |
| --- | --- | --- |
| マイページ UI | 個人ダッシュボード、トークン残高、通知集約、日記/SNS 入口 | Next.js PWA + Django `/api/mypage/*` |
| SNS UI | 公開日記・アバターのフィード、共有/モデレーション表示 | Next.js PWA + Django `/api/social/*` |
| アバターライフサイクル | 作成〜公開、バージョン管理、審査フロー | Django `kuden_ai.avatar` + 管理画面 + Celery 審査タスク |
| トークン台帳 | 使用量・チャージ・ロールアップ・請求照合 | Django `token_ledger` + Celery rollup + Langfuse |
| 課金連携 | PSP (Stripe 等) との webhook、請求同期 | Django webhook エンドポイント + Celery 再試行処理 |
| RAG/ナレッジ管理 | 日記やナレッジ投入、埋め込み生成、検索 | Celery embedding worker + LangChain + Pinecone |
| 通知配信 | メール/WebPush/SMS でのイベント通知 | Celery `notifications.*` + Redis レート制限 |

---

## 4. 論理データフロー

1. **PWA でのユーザー操作**  
   - Service Worker がシェルと翻訳バンドルをキャッシュ。  
   - Next.js が Django REST API からローカライズ済みデータとセッショントークンを取得。
2. **認証・セッション管理**  
   - Django (DRF + django-allauth) が JWT/refresh を発行し HttpOnly Cookie に格納。  
   - Redis が SSO/2FA セッション、OTP、レート制限カウンタを保持。
3. **コンテンツ / アバター管理**  
   - CRUD API が PostgreSQL の JSONB カラムを更新。  
   - 保存トリガで Celery が Pinecone 埋め込みを再生成。  
   - LangChain がプロンプトテンプレートとレスポンスストリーミングを制御。
4. **トークン会計と可視化**  
   - LLM 呼び出しごとに Langfuse へ trace を送信し `token_ledger` とリンク。  
   - Celery 夜間ジョブで Langfuse 使用量と台帳を突合・異常を通知。
5. **SNS/公開フィード**  
   - Celery がモデレーション結果を反映し、不適切投稿を自動非公開。  
   - Redis にホットエントリをキャッシュし、フォールバックで PostgreSQL を参照。
6. **通知配信**  
   - Celery がメール/Push/SMS をキューイング。  
   - WebPush エンドポイントはロケール情報付きで PostgreSQL に保存。

---

## 5. マイグレーション & ビルド計画

| フェーズ | 目的 | 主なタスク |
| --- | --- | --- |
| Phase 0: 資産収集 | 既存ソース/データの確認 | 欠落ファイルの収集、既存 API や外部サービス一覧の整理。 |
| Phase 1: プラットフォーム基盤 | 目標スタックの立ち上げ | - Django プロジェクトと `kuden_ai` アプリを scaffold。<br/>- PostgreSQL スキーマ（users, avatars, diary_entries, token_ledger, billing_events 等）作成。<br/>- Redis/Celery/LangChain/Pinecone/Langfuse 接続設定。<br/>- Next.js PWA + 多言語対応 (i18next/next-intl)。 |
| Phase 2: ドメイン再実装 | 主要機能の再構築 | - マイページ / SNS API を実装。<br/>- アバター審査フロー + 管理画面。<br/>- 課金連携と台帳ロールアップ。<br/>- 日記/RAG 埋め込みパイプライン。 |
| Phase 3: 可観測性 & ハードニング | 信頼性/セキュリティ強化 | - Langfuse トレーシングとアラート。<br/>- レート制限、2FA、監査ログ。<br/>- Celery パイプラインの負荷テスト。<br/>- DR/バックアップ戦略の確立。 |

---

## 6. インターフェースとファイル契約

| インターフェース | 契約 | 備考 |
| --- | --- | --- |
| REST/GraphQL API | Django から OpenAPI 3 をエクスポート | `/api/mypage`, `/api/social`, `/api/avatars`, `/api/token-ledger`, `/api/billing/webhook` 等を含む。 |
| Celery タスク | ドメイン別タスク命名 | 例: `kuden_ai.avatar.embed`, `ledger.rollup.daily`, `notifications.dispatch`。 |
| Pinecone インデックス | `avatar-{tenant}`, `diary-{tenant}`, `knowledge-public` | メタデータに `tenant_id`, `locale`, `visibility` を含める。 |
| Langfuse トレース | Trace ID = `{tenant_id}:{session_id}:{uuid}` | `token_delta`, `avatar_id`, `prompt_template` などカスタム属性を付与。 |
| 翻訳バンドル | `/public/locales/{lang}/{namespace}.json` | Next.js PWA からロード。欠損時は `ja` をフォールバック。 |

---

## 7. ギャップ / オープンクエスチョン

1. **レガシーデータ:** 実際の CSV / SQL が必要。PostgreSQL や Pinecone への移行手順に影響。  
2. **認証基盤:** 既存 SSO 連携か独立認証かを確定する必要あり。  
3. **決済プロバイダ:** Stripe / Komoju などどれを採用するかで webhook スキーマが変わる。  
4. **モデレーション方針:** 自動非公開の閾値や人手確認フローの設計が未定。  
5. **SNS 要件:** WebRTC などリアルタイム機能が必要か、静的フィードで十分か。  
6. **デプロイ先:** Kubernetes / ECS / VM など Celery・Redis・Langfuse 接続要件を決める必要あり。

---

## 8. 直近のアクションアイテム

1. 欠落しているソース/データをリポジトリに追加し、本ドキュメントを更新。  
2. 目標アーキテクチャ案をレビューし、差分要望があれば共有。  
3. 承認後、具体的なタスクリスト（例: Django スケルトン作成、PostgreSQL スキーマ設計）をチケット化して実装を開始。

本書は、既存アセットを Django / Celery / Redis / LangChain / Pinecone / Langfuse / PostgreSQL へ統合する際に参照させるためのドキュメントです。内容は 2025-08-31 時点で確認できたリポジトリ構成に基づいています。

---

## 1. リポジトリ調査結果

| 項目 | 所見 |
| --- | --- |
| ソースツリー | `backend/mysql`、`frontend/node_modules`、`mysql/…` など空ディレクトリのみ。アプリケーションコードや設定ファイルは未配置。 |
| データ資産 | `questions.csv`、`dump.sql` などの名前付きディレクトリは存在するが中身は空で、テーブル定義・スキーマを推測できず。 |
| 運用スクリプト | Dockerfile / docker-compose / CI 設定等は未提供。 |
| 結論 | 現状は要件のみが共有されており、実装資産を流用できないため「新規リプラットフォーム」として扱う必要がある。 |

> **アクション:** もし別場所にソースやデータが存在する場合は追加で共有し、本ドキュメントを随時更新する。

---

## 2. 目標アーキテクチャ概要

| レイヤ | 採用技術 | 役割 |
| --- | --- | --- |
| プレゼンテーション (Web/PWA) | Next.js 系フレームワーク + Service Worker | マイページ・SNS 画面を多言語/オフライン対応で提供。 |
| アプリケーション / API | **Django** (REST/GraphQL, JWT/SSO 認証) | 認証・管理画面・ビリング・AI アバタードメイン API を集約。 |
| ドメインアプリ | `kuden_ai` Django アプリ | AI アバター管理、トークン台帳、課金連携、公開/モデレーション統制。 |
| 非同期処理 | **Celery** + Redis broker/beat | usage 集計、RAG 埋め込み、トークンロールアップ、通知配送など。 |
| キャッシュ/キュー | **Redis** | セッション、OTP、レート制限、WebRTC シグナリング、Celery backend。 |
| AI/RAG 制御 | **LangChain** | OpenAI / Gemini / Claude 等 LLM の抽象化、プロンプト管理、ソース選択。 |
| ベクトル DB | **Pinecone** | アバター・日記・ナレッジの埋め込みをテナント/スコープ別に保持。 |
| 追跡・可視化 | **Langfuse** | LLM トレース、トークン使用量監視、コスト配賦、異常検知。 |
| 永続 DB | **PostgreSQL** | ユーザー、アバター、会話履歴、課金ログを JSONB + 部分暗号で管理。 |

---

## 3. ドメイン機能マッピング

| 機能 | 説明 | 担当コンポーネント |
| --- | --- | --- |
| マイページ UI | 個人ダッシュボード、トークン残高、通知集約、日記/SNS 入口 | Next.js PWA + Django `/api/mypage/*` |
| SNS UI | 公開日記・アバターのフィード、共有/モデレーション表示 | Next.js PWA + Django `/api/social/*` |
| アバターライフサイクル | 作成〜公開、バージョン管理、審査フロー | Django `kuden_ai.avatar` + 管理画面 + Celery 審査タスク |
| トークン台帳 | 使用量・チャージ・ロールアップ・請求照合 | Django `token_ledger` + Celery rollup + Langfuse |
| 課金連携 | PSP (Stripe 等) との webhook、請求同期 | Django webhook エンドポイント + Celery 再試行処理 |
| RAG/ナレッジ管理 | 日記やナレッジ投入、埋め込み生成、検索 | Celery embedding worker + LangChain + Pinecone |
| 通知配信 | メール/WebPush/SMS でのイベント通知 | Celery `notifications.*` + Redis レート制限 |

---

## 4. 論理データフロー

1. **PWA でのユーザー操作**  
   - Service Worker がシェルと翻訳バンドルをキャッシュ。  
   - Next.js が Django REST API からローカライズ済みデータとセッショントークンを取得。
2. **認証・セッション管理**  
   - Django (DRF + django-allauth) が JWT/refresh を発行し HttpOnly Cookie に格納。  
   - Redis が SSO/2FA セッション、OTP、レート制限カウンタを保持。
3. **コンテンツ / アバター管理**  
   - CRUD API が PostgreSQL の JSONB カラムを更新。  
   - 保存トリガで Celery が Pinecone 埋め込みを再生成。  
   - LangChain がプロンプトテンプレートとレスポンスストリーミングを制御。
4. **トークン会計と可視化**  
   - LLM 呼び出しごとに Langfuse へ trace を送信し `token_ledger` とリンク。  
   - Celery 夜間ジョブで Langfuse 使用量と台帳を突合・異常を通知。
5. **SNS/公開フィード**  
   - Celery がモデレーション結果を反映し、不適切投稿を自動非公開。  
   - Redis にホットエントリをキャッシュし、フォールバックで PostgreSQL を参照。
6. **通知配信**  
   - Celery がメール/Push/SMS をキューイング。  
   - WebPush エンドポイントはロケール情報付きで PostgreSQL に保存。

---

## 5. マイグレーション & ビルド計画

| フェーズ | 目的 | 主なタスク |
| --- | --- | --- |
| Phase 0: 資産収集 | 既存ソース/データの確認 | 欠落ファイルの収集、既存 API や外部サービス一覧の整理。 |
| Phase 1: プラットフォーム基盤 | 目標スタックの立ち上げ | - Django プロジェクトと `kuden_ai` アプリを scaffold。<br/>- PostgreSQL スキーマ（users, avatars, diary_entries, token_ledger, billing_events 等）作成。<br/>- Redis/Celery/LangChain/Pinecone/Langfuse 接続設定。<br/>- Next.js PWA + 多言語対応 (i18next/next-intl)。 |
| Phase 2: ドメイン再実装 | 主要機能の再構築 | - マイページ / SNS API を実装。<br/>- アバター審査フロー + 管理画面。<br/>- 課金連携と台帳ロールアップ。<br/>- 日記/RAG 埋め込みパイプライン。 |
| Phase 3: 可観測性 & ハードニング | 信頼性/セキュリティ強化 | - Langfuse トレーシングとアラート。<br/>- レート制限、2FA、監査ログ。<br/>- Celery パイプラインの負荷テスト。<br/>- DR/バックアップ戦略の確立。 |

---

## 6. インターフェースとファイル契約

| インターフェース | 契約 | 備考 |
| --- | --- | --- |
| REST/GraphQL API | Django から OpenAPI 3 をエクスポート | `/api/mypage`, `/api/social`, `/api/avatars`, `/api/token-ledger`, `/api/billing/webhook` 等を含む。 |
| Celery タスク | ドメイン別タスク命名 | 例: `kuden_ai.avatar.embed`, `ledger.rollup.daily`, `notifications.dispatch`。 |
| Pinecone インデックス | `avatar-{tenant}`, `diary-{tenant}`, `knowledge-public` | メタデータに `tenant_id`, `locale`, `visibility` を含める。 |
| Langfuse トレース | Trace ID = `{tenant_id}:{session_id}:{uuid}` | `token_delta`, `avatar_id`, `prompt_template` などカスタム属性を付与。 |
| 翻訳バンドル | `/public/locales/{lang}/{namespace}.json` | Next.js PWA からロード。欠損時は `ja` をフォールバック。 |

---

## 7. ギャップ / オープンクエスチョン

1. **レガシーデータ:** 実際の CSV / SQL が必要。PostgreSQL や Pinecone への移行手順に影響。  
2. **認証基盤:** 既存 SSO 連携か独立認証かを確定する必要あり。  
3. **決済プロバイダ:** Stripe / Komoju などどれを採用するかで webhook スキーマが変わる。  
4. **モデレーション方針:** 自動非公開の閾値や人手確認フローの設計が未定。  
5. **SNS 要件:** WebRTC などリアルタイム機能が必要か、静的フィードで十分か。  
6. **デプロイ先:** Kubernetes / ECS / VM など Celery・Redis・Langfuse 接続要件を決める必要あり。

---

## 8. 直近のアクションアイテム

1. 欠落しているソース/データをリポジトリに追加し、本ドキュメントを更新。  
2. 目標アーキテクチャ案をレビューし、差分要望があれば共有。  
3. 承認後、具体的なタスクリスト（例: Django スケルトン作成、PostgreSQL スキーマ設計）をチケット化して実装を開始。
