# Pages Overview

Kuden.AI の現行システムを構成する主要ページ/画面の役割とバックエンド連携を、入力ドキュメント（00〜08）を踏まえて整理する。全ページは Next.js(PWA) を基本とし、Django API・Redis・PostgreSQL・LangChain・Pinecone・Stripe・Langfuse と接続する。

## 1. 認証・登録ライン
- **ログインページ**: メール/パスワード送信→Django で `authenticate`。成功後は Django-OTP が 6 桁コード/TOTP を生成し、Redis `otp:{user_id}` (TTL5分) に格納。画面ではカウントダウンと再送クールダウン(30秒)を表示。
- **OTPページ**: ワンタイムコード入力で Redis 値を検証。成功すると `session:{user_id}:{uuid}` を発行し完全ログイン。失敗5回でアカウントロック→管理者解除。
- **新規登録ページ**: 名前/職業/年齢/居住地など基本プロフィールを同時入力。登録完了後に 2FA 認証へ遷移し、プロフィール初期値は `profiles` に保存。
- **パスワードリセットページ**: ログイン画面下部リンク→メール入力→Redis `pwdreset:{token}`(TTL10分)へ格納。リンクから再設定し、完了時に全セッション削除＆監査ログ記録。

## 2. ダッシュボード
- **ホームカード**: 日記/チャット/アバター/トークンのカードから各ページを起動。「どの段階からでもチャットbot起動＆固定URL発行」が可能。
- **利用状況パネル**: token_ledger・usage_counters・Langfuse から取得した使用量/トークン残量/コストを可視化。残量不足時は Stripe 購入導線を表示。
- **RAG/ジョブ状況**: 接続済みソース (Drive/Notion/S3) と埋め込み状態、バッチ進行を表示。Celery 失敗時は警告。

## 3. 日記（チャットUI）
- **会話ビュー**: 「AIが質問→ユーザー回答→AIが要約/追記」を 1 タイムラインで提示。質問は LangChain がランダム/文脈生成し、回答はテキスト/音声(WebRTC+Whisper)対応。
- **日記本文/要約エリア**: 会話から生成されたサマリ、追記提案、感情/タグを表示。ユーザーが追記した内容も会話として扱い、`diary_entries` + `diary_messages` に保存。
- **既存日記検索**: LangChain 経由で Pinecone を検索し、引用ハイライトと出典を表示。機密フラグ付きエントリは検索対象外。
- **保存タイミング**: 1日分の会話は Redis `diary:buffer` に保持し、03:00 の Celery バッチで PostgreSQL へ永続化→Pinecone upsert(id=hash(user_id+text))→Langfuse trace登録。

## 4. AIアバタースタジオ
- **プロフィール入力率表示**: 名前/アイコン/職業/年齢/居住地/公開フラグ/機密チェックボックスの入力状況を % 表示し、入力度に応じて進捗ゲージを更新。
- **性格診断 & 文体チェック**: trait 判定ジョブを実行し、`avatar_traits` にスコア＋エビデンスを保存。結果はカード表示。
- **プロンプト/安全ルール編集**: システム/ロール/安全/評価/テストプロンプトを分離管理し、バージョン履歴 (`avatar_prompts`) を作成。
- **公開設定/固定URL発行**: 公開ONで `https://app.kuden.ai/@handle` を生成し、SNS機能（タイムライン/フォロー/いいね/コメント/シェア/通報）へ連携。限定公開/非公開/年齢制限/企業用途フラグを設定可。

## 5. チャット（アバター対話）
- **会話開始導線**: アバター探索→お気に入り登録→チャット開始の流れを踏襲。URL 直打ちでも立ち上げ可。
- **RAG切替**: 個人/業務ソースや引用部分のハイライトを選択。非公開データは本人のみ参照可。
- **トークン利用表示**: 会話ごとに入力/出力トークン数、課金計算、token_ledger ID、Langfuse trace ID を表示し、ユーザーの利用量ページとも連動。

## 6. プロフィール & セキュリティ
- **基本情報編集**: 名前/アイコン/職業/年齢/居住地、AI公開フラグを更新。機密情報欄にはチェックボックスを設け、AES 列暗号化対象を選択。
- **セキュリティ設定**: 2FA(TOTP/メールOTP) の登録・解除、セッション一覧・リモートログアウト、パスワード変更（成功後は全端末ログアウト）。
- **性格診断/診断サマリ**: trait や診断結果の JSON を表示し、再生成は別セッションとして日付管理。

## 7. 課金・トークン
- **プラン管理ページ**: Free/Pro/Business の差分（アバター上限/月間トークン）と現在のサブスク状態を表示。Stripe Checkout/Customer Portal へ遷移。
- **追加トークン購入**: Stripe でアドオン購入。Webhook 受信後に `purchases`・`token_ledger`・`usage_counters` を更新。
- **利用量ログ**: 日次ロールアップ値、会話単位の仕訳、Langfuse 上の使用量をグラフ表示。帳票（請求履歴/インボイス）出力に対応。

## 8. 管理・モデレーション
- **ユーザー管理**: 有効/無効、強制パスリセット、トークン調整。`admin_events`・`audit_logs` をタイムライン表示。
- **通報キュー**: SNS通報/アバターブロック、違反対応履歴。モデレーションアクションは監査ログに記録。
- **お知らせ/広告**: プラン/地域/利用状況別にセグメント配信。LP/ヘルプの CMS 編集も同領域で操作。
- **メトリクス**: MAU/DAU、会話成功率、RAG命中率、ARPU、LTV、トークン収支をダッシュボード表示。Langfuse/BigQuery から集計。

## 9. モバイル/PWA
- Web 版（レスポンシブ/PWA）をカバーしつつ、App Store / Google Play へ配信する同一コードベースのスマホアプリを想定。`GET /api/mobile/bootstrap` で状況データを取得し、ディープリンクでチャットを即起動。

## 10. クロスカッティング要件
- **データ管理**: 会話・日記・診断・AI会話ログは PostgreSQL へ保存し、保存イベントごとに Pinecone へ embedding upsert。Langfuse で LLM/RAG/Embedding/Token を可視化。
- **トークン記帳**: 各メッセージ完了時に `actual_tokens` を確定し、token_ledger へユーザー→運営、運営→アバターを二重仕訳。usage_counters へ日次集計し、Langfuse/ダッシュボードへ連携。
- **セキュリティ**: 2FA 必須、RBAC、PII 列暗号、WAF、CloudWatch/Sentry/Slack 通知。OTP/パスリセット/公開設定変更は監査記録。
- **ナイトリーバッチ**: 03:00 に Celery が Redis バッファを Postgres へフラッシュし、BigQuery/Redshift へストリーム、S3 バックアップを実行。

この pages.md をハブとして、詳細は `input_document/00〜08` の各章を参照する。
